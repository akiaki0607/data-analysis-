{% extends "base.html" %}

{% block content %}
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
            <i class="fas fa-upload"></i> 数据上传
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="preprocess-tab" data-bs-toggle="tab" data-bs-target="#preprocess" type="button" role="tab">
            <i class="fas fa-cogs"></i> 数据预处理
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="identify-tab" data-bs-toggle="tab" data-bs-target="#identify" type="button" role="tab">
            <i class="fas fa-search"></i> 品牌识别
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
            <i class="fas fa-chart-bar"></i> 深度分析
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
            <i class="fas fa-file-alt"></i> 生成报告
        </button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade show active" id="upload" role="tabpanel">
        <div class="content-section">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3>上传数据源文件</h3>
                        <p class="text-muted mb-4">支持 Excel (.xlsx) 和 CSV (.csv) 格式</p>
                        <p class="text-muted mb-4">拖拽文件到此处或点击选择文件</p>
                        <input type="file" id="fileInput" accept=".xlsx,.csv" style="display: none;">
                        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click();">
                            <i class="fas fa-folder-open"></i> 选择文件
                        </button>
                    </div>
                    
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">处理中...</span>
                        </div>
                        <p class="mt-3">正在处理文件，请稍候...</p>
                    </div>
                    
                    <div class="alert alert-info mt-4" id="uploadStatus" style="display: none;">
                        <i class="fas fa-info-circle"></i> <span id="statusMessage"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="preprocess" role="tabpanel">
        <div class="content-section">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 数据预处理功能将在文件上传后自动激活
            </div>
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-database"></i> 数据转换过程
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>宽表转长表</h6>
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>数据清洗</h6>
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="identify" role="tabpanel">
        <div class="content-section">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 品牌识别功能将在数据预处理完成后激活
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">客户名称</div>
                        <div class="card-body text-center">
                            <h4 id="clientName">-</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">核心竞品</div>
                        <div class="card-body">
                            <div id="coreCompetitors">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">其他竞品</div>
                        <div class="card-body">
                            <div id="otherCompetitors">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="analysis" role="tabpanel">
        <div class="content-section">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 深度分析功能将在品牌识别完成后激活
            </div>
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> 分析进度
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <h5>薄弱组合识别</h5>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <h5>蓝海关键词筛选</h5>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <h5>优先级排序</h5>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <h5>信源平台分析</h5>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="report" role="tabpanel">
        <div class="content-section">
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 报告生成功能将在深度分析完成后激活
            </div>
            <div class="text-center">
                <button class="btn btn-primary btn-lg" disabled>
                    <i class="fas fa-download"></i> 生成完整报告
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 文件上传处理
    $('#fileInput').change(function() {
        const file = this.files[0];
        if (file) {
            uploadFile(file);
        }
    });
    
    // 拖拽上传
    $('#uploadArea').on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('border-success');
    });
    
    $('#uploadArea').on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('border-success');
    });
    
    $('#uploadArea').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('border-success');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            uploadFile(files[0]);
        }
    });
    
    $('#uploadArea').click(function() {
        $('#fileInput').click();
    });
});

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    $('#loadingSpinner').show();
    $('#uploadStatus').hide();
    
    $.ajax({
        url: '/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            $('#loadingSpinner').hide();
            
            if (response.success) {
                $('#statusMessage').text(response.message);
                $('#uploadStatus').removeClass('alert-danger').addClass('alert-success').show();
                
                // 模拟进度条动画
                animateProgress();
                
                // 跳转到分析页面
                setTimeout(function() {
                    if (response.redirect) {
                        window.location.href = response.redirect;
                    }
                }, 2000);
            } else {
                $('#statusMessage').text(response.message);
                $('#uploadStatus').removeClass('alert-success').addClass('alert-danger').show();
            }
        },
        error: function() {
            $('#loadingSpinner').hide();
            $('#statusMessage').text('上传失败，请重试');
            $('#uploadStatus').removeClass('alert-success').addClass('alert-danger').show();
        }
    });
}

function animateProgress() {
    // 激活后续标签页
    $('#preprocess-tab').removeClass('disabled');
    $('#identify-tab').removeClass('disabled');
    $('#analysis-tab').removeClass('disabled');
    $('#report-tab').removeClass('disabled');
    
    // 动画效果
    $('.progress-bar').each(function(index) {
        const $this = $(this);
        setTimeout(function() {
            $this.animate({width: '100%'}, 1000);
        }, index * 300);
    });
}
</script>
{% endblock %}