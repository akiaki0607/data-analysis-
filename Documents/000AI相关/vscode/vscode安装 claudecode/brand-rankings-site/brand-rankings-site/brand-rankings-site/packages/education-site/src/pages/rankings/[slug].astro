---
// æ’è¡Œæ¦œè¯¦æƒ…é¡µ
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import TopThreePodium from '../../components/TopThreePodium.astro';
import BrandListItem from '../../components/BrandListItem.astro';
import { loadRanking, loadRankingsByIndustry, getIndustryById } from '../../utils/dataLoader';
import { formatDate, formatNumber } from '../../utils/helpers';

export async function getStaticPaths() {
  const rankings = loadRankingsByIndustry('education');

  return rankings.map((ranking) => ({
    params: { slug: ranking.slug },
    props: { ranking }
  }));
}

const { ranking } = Astro.props;
const industry = getIndustryById(ranking.category);

if (!industry) {
  return Astro.redirect('/404');
}

const breadcrumbItems = [
  { label: 'é¦–é¡µ', href: '/' },
  { label: industry.name, href: '/' },
  { label: ranking.title }
];

// åˆ†ç¦»Top 3å’Œå…¶ä½™å“ç‰Œ
const topThree = ranking.brands.slice(0, 3);
const restBrands = ranking.brands.slice(3);

// è·å–ç›¸å…³æ’è¡Œæ¦œæ¨è
const relatedRankings = loadRankingsByIndustry('education')
  .filter(r => r.id !== ranking.id)
  .slice(0, 3);
---

<BaseLayout
  title={ranking.title}
  description={ranking.description}
>
  <!-- Header with Breadcrumb -->
  <header class="bg-white border-b border-neutral-200 sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4">
      <Breadcrumb items={breadcrumbItems} />

      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center space-x-3">
          <span class="text-2xl">{industry.icon}</span>
          <span class="text-lg font-display font-semibold text-neutral-900">
            {industry.name}
          </span>
        </div>
        <a
          href="/"
          class="hidden md:block text-sm text-neutral-600 hover:text-primary-600 transition-colors"
        >
          â† è¿”å›è¡Œä¸šé¦–é¡µ
        </a>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-8 md:py-12">

    <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
    <header class="mb-12">
      <div class="flex items-start justify-between mb-4">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-display font-extrabold text-neutral-900">
          ğŸ† {ranking.title}
        </h1>

        <!-- åˆ†äº«æŒ‰é’®(å¯é€‰) -->
        <button class="hidden md:block px-4 py-2 border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
          <span class="text-neutral-600">åˆ†äº«</span>
        </button>
      </div>

      <p class="text-lg md:text-xl text-neutral-600 mb-6 leading-relaxed">
        {ranking.description}
      </p>

      <!-- å…ƒæ•°æ® -->
      <div class="flex flex-wrap items-center gap-4 text-sm md:text-base text-neutral-600">
        <div class="flex items-center space-x-2">
          <span>ğŸ“Š</span>
          <span>å…± <strong class="text-neutral-900">{ranking.brands.length}</strong> ä¸ªå“ç‰Œ</span>
        </div>
        <div class="flex items-center space-x-2">
          <span>ğŸ”„</span>
          <span>æ›´æ–°äº <strong class="text-neutral-900">{formatDate(ranking.updateDate)}</strong></span>
        </div>
        {ranking.viewCount && (
          <div class="flex items-center space-x-2">
            <span>ğŸ“ˆ</span>
            <span><strong class="text-neutral-900">{formatNumber(ranking.viewCount)}</strong> æµè§ˆ</span>
          </div>
        )}
      </div>

      <!-- è¯„ä¼°æ–¹æ³•è¯´æ˜ -->
      {ranking.methodology && (
        <div class="mt-6 p-4 bg-neutral-50 border border-neutral-200 rounded-lg">
          <h3 class="text-sm font-semibold text-neutral-900 mb-2">è¯„ä¼°æ–¹æ³•</h3>
          <p class="text-sm text-neutral-600 leading-relaxed">
            {ranking.methodology}
          </p>
        </div>
      )}
    </header>

    <!-- Top 3 é¢†å¥–å° -->
    {topThree.length >= 3 && (
      <TopThreePodium brands={topThree} />
    )}

    <!-- å®Œæ•´æ’è¡Œæ¦œåˆ—è¡¨ -->
    {restBrands.length > 0 && (
      <section class="mb-16">
        <h2 class="text-2xl md:text-3xl font-display font-bold text-neutral-900 mb-6">
          å®Œæ•´æ’è¡Œæ¦œ (#{topThree.length + 1}-#{ranking.brands.length})
        </h2>

        <div class="space-y-3">
          {restBrands.map((brand) => (
            <BrandListItem brand={brand} />
          ))}
        </div>
      </section>
    )}

    <!-- ç›¸å…³æ’è¡Œæ¦œæ¨è -->
    {relatedRankings.length > 0 && (
      <section class="bg-white rounded-2xl p-6 md:p-12 border border-neutral-200">
        <h2 class="text-2xl md:text-3xl font-display font-bold text-neutral-900 mb-6">
          ç›¸å…³æ’è¡Œæ¦œæ¨è
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedRankings.map((related) => (
            <a href={`/rankings/${related.slug}`} class="group block">
              <div class="border border-neutral-200 rounded-lg p-6 hover:shadow-card-hover transition-shadow h-full">
                <div class="flex items-center space-x-2 mb-3">
                  <span class={`w-2 h-2 rounded-full bg-industry-${related.category}`}></span>
                  <span class="text-xs text-neutral-600">{industry.name}</span>
                </div>
                <h3 class="text-lg font-semibold text-neutral-900 group-hover:text-primary-600 transition-colors mb-2 line-clamp-2">
                  {related.title}
                </h3>
                <p class="text-sm text-neutral-600 mt-2">
                  Top {related.brands.length}å“ç‰Œ â€¢ {formatDate(related.updateDate)}
                </p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

  </div>
</BaseLayout>
