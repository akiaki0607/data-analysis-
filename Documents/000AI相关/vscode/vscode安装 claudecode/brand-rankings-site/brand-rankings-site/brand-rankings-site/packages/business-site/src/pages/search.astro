---
// æœç´¢ç»“æœé¡µ
import BaseLayout from '../layouts/BaseLayout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import { getIndustryById } from '../utils/dataLoader';

const industry = getIndustryById('business');

if (!industry) {
  return Astro.redirect('/404');
}

const breadcrumbItems = [
  { label: 'é¦–é¡µ', href: '/' },
  { label: industry.name, href: '/' },
  { label: 'æœç´¢ç»“æœ' }
];

// ä» URL è·å–æœç´¢å…³é”®è¯
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
---

<BaseLayout
  title={query ? `æœç´¢"${query}" - ${industry.name}` : `æœç´¢ - ${industry.name}`}
  description={`åœ¨${industry.name}è¡Œä¸šä¸­æœç´¢å“ç‰Œå’Œæ’è¡Œæ¦œ`}
>
  <!-- Header with Breadcrumb -->
  <header class="bg-white border-b border-neutral-200">
    <div class="container mx-auto px-4 py-4">
      <Breadcrumb items={breadcrumbItems} />

      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center space-x-3">
          <span class="text-2xl">{industry.icon}</span>
          <span class="text-lg font-display font-semibold text-neutral-900">
            {industry.name} æœç´¢
          </span>
        </div>
        <a
          href="/"
          class="hidden md:block text-sm text-neutral-600 hover:text-primary-600 transition-colors"
        >
          â† è¿”å›è¡Œä¸šé¦–é¡µ
        </a>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-4 py-8 md:py-12">

    <!-- æœç´¢æ¡† -->
    <div class="max-w-3xl mx-auto mb-12">
      <div class="relative">
        <input
          type="text"
          id="search-page-input"
          value={query}
          placeholder="æœç´¢å“ç‰Œæˆ–æ’è¡Œæ¦œ..."
          class="w-full px-6 py-4 pl-14 text-lg border-2 border-neutral-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all shadow-sm"
          autofocus
        />
        <span class="absolute left-5 top-1/2 -translate-y-1/2 text-2xl text-neutral-400">
          ğŸ”
        </span>
      </div>

      {query && (
        <div class="mt-4 text-neutral-600">
          æœç´¢å…³é”®è¯: <strong class="text-neutral-900">"{query}"</strong>
        </div>
      )}
    </div>

    <!-- æœç´¢ç»“æœåŒºåŸŸ -->
    <div id="search-results-container" class="max-w-4xl mx-auto">
      <!-- åŠ è½½æç¤º -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-neutral-200 border-t-primary-600"></div>
        <div class="mt-4 text-neutral-600">æœç´¢ä¸­...</div>
      </div>

      <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      <div id="results" class="hidden">
        <div id="results-count" class="mb-6 text-neutral-600"></div>
        <div id="results-list" class="space-y-4"></div>
      </div>

      <!-- æ— ç»“æœæç¤º -->
      <div id="no-results" class="hidden text-center py-12">
        <div class="text-6xl mb-4">ğŸ”</div>
        <h3 class="text-2xl font-display font-bold text-neutral-900 mb-2">
          æœªæ‰¾åˆ°ç›¸å…³ç»“æœ
        </h3>
        <p class="text-neutral-600 mb-6">
          è¯•è¯•å…¶ä»–å…³é”®è¯ï¼Œæˆ–æµè§ˆä»¥ä¸‹å†…å®¹
        </p>
        <div class="flex justify-center gap-4">
          <a
            href="/"
            class="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
          >
            æµè§ˆæ’è¡Œæ¦œ
          </a>
          <a
            href="/"
            class="px-6 py-3 border-2 border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors font-medium"
          >
            è¿”å›é¦–é¡µ
          </a>
        </div>
      </div>
    </div>

  </div>
</BaseLayout>

<script>
  // Pagefind æœç´¢åŠŸèƒ½
  let pagefind: any = null;

  async function initPagefind() {
    try {
      // @ts-ignore
      pagefind = await import('/pagefind/pagefind.js');
      await pagefind.options({
        excerptLength: 30
      });
    } catch (error) {
      console.error('Failed to load Pagefind:', error);
    }
  }

  async function performSearch(query: string) {
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const noResults = document.getElementById('no-results');
    const resultsList = document.getElementById('results-list');
    const resultsCount = document.getElementById('results-count');

    if (!query || query.length < 2) {
      loading?.classList.add('hidden');
      noResults?.classList.remove('hidden');
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    loading?.classList.remove('hidden');
    results?.classList.add('hidden');
    noResults?.classList.add('hidden');

    if (!pagefind) {
      await initPagefind();
    }

    if (!pagefind) {
      loading?.classList.add('hidden');
      if (resultsList) {
        resultsList.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <div class="text-red-600">æœç´¢åŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
          </div>
        `;
      }
      results?.classList.remove('hidden');
      return;
    }

    try {
      const searchResults = await pagefind.search(query);

      loading?.classList.add('hidden');

      if (searchResults.results.length === 0) {
        noResults?.classList.remove('hidden');
        return;
      }

      // è·å–è¯¦ç»†ç»“æœæ•°æ®
      const resultsData = await Promise.all(
        searchResults.results.map((r: any) => r.data())
      );

      // æ˜¾ç¤ºç»“æœæ•°é‡
      if (resultsCount) {
        resultsCount.textContent = `æ‰¾åˆ° ${searchResults.results.length} ä¸ªç»“æœ`;
      }

      // æ¸²æŸ“ç»“æœåˆ—è¡¨
      if (resultsList) {
        resultsList.innerHTML = resultsData.map((data: any) => `
          <a
            href="${data.url}"
            class="block bg-white border border-neutral-200 rounded-lg p-6 hover:shadow-card-hover transition-all duration-250 hover:-translate-y-0.5"
          >
            <h3 class="text-xl font-semibold text-neutral-900 mb-2 hover:text-primary-600 transition-colors">
              ${data.meta.title || 'æ— æ ‡é¢˜'}
            </h3>
            <div class="text-neutral-600 mb-3 line-clamp-3">
              ${data.excerpt || ''}
            </div>
            <div class="text-sm text-primary-600 font-medium">
              æŸ¥çœ‹è¯¦æƒ… â†’
            </div>
          </a>
        `).join('');
      }

      results?.classList.remove('hidden');

    } catch (error) {
      console.error('Search error:', error);
      loading?.classList.add('hidden');

      if (resultsList) {
        resultsList.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <div class="text-red-600">æœç´¢å‡ºé”™ï¼Œè¯·ç¨åå†è¯•</div>
          </div>
        `;
      }
      results?.classList.remove('hidden');
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæœç´¢
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q') || '';

  if (initialQuery) {
    performSearch(initialQuery);
  } else {
    document.getElementById('loading')?.classList.add('hidden');
    document.getElementById('no-results')?.classList.remove('hidden');
  }

  // ç›‘å¬æœç´¢æ¡†è¾“å…¥
  const searchInput = document.getElementById('search-page-input') as HTMLInputElement;
  if (searchInput) {
    let debounceTimer: number;

    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();

      clearTimeout(debounceTimer);

      debounceTimer = window.setTimeout(() => {
        // æ›´æ–° URL
        const url = new URL(window.location.href);
        if (query) {
          url.searchParams.set('q', query);
        } else {
          url.searchParams.delete('q');
        }
        window.history.pushState({}, '', url);

        // æ‰§è¡Œæœç´¢
        performSearch(query);
      }, 500);
    });

    // æ”¯æŒ Enter é”®æœç´¢
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        clearTimeout(debounceTimer);
        const query = (e.target as HTMLInputElement).value.trim();
        performSearch(query);
      }
    });
  }
</script>
