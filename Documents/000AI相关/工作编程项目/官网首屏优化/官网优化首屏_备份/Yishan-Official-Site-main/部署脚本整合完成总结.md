# 部署脚本整合完成总结

> **完成时间**: 2025-10-15  
> **任务目标**: 整合新旧部署脚本，统一PM2进程名配置，添加文档清理机制说明

---

## ✅ 完成的任务

### 1. 脚本文件修正（4个文件）

#### ✅ `scripts/setup-git-deploy.sh`
- **修改**: 第19行 `APP_NAME="yishan"` → `APP_NAME="yishan-official"`
- **作用**: 首次部署脚本，确保PM2进程名统一

#### ✅ `scripts/deploy-update.sh`
- **修改**: 第19行 `APP_NAME="yishan"` → `APP_NAME="yishan-official"`
- **作用**: 日常更新脚本，确保PM2进程名统一

#### ✅ `scripts/rollback.sh`
- **修改**: 第19行 `APP_NAME="yishan"` → `APP_NAME="yishan-official"`
- **作用**: 紧急回滚脚本，确保PM2进程名统一

#### ✅ `scripts/deploy.sh` - 增强版
- **完全重写**: 保留原有的5步流程 + 文档清理步骤
- **新增功能**:
  - ✅ 彩色输出（提升可读性）
  - ✅ 版本检测（无更新时跳过构建）
  - ✅ 智能依赖检测（package.json变化才执行npm install）
  - ✅ 构建失败自动回滚
  - ✅ PM2进程检测（未找到时提示执行首次部署）
  - ✅ 详细的部署结果输出
  - ✅ 自动显示最近日志
- **保留功能**:
  - ✅ 调用 `deploy-clean.sh` 清理文档（第3步）
  - ✅ 支持 `.gitattributes` 标记机制

---

### 2. 配置文件修正（2个文件）

#### ✅ `ecosystem.config.js`
- **修改**: 第3行 `name: 'yishan'` → `name: 'yishan-official'`
- **作用**: PM2配置文件，确保进程名统一

#### ✅ `package.json`
- **修改**: 第16-18行，所有PM2命令的进程名统一
  ```json
  "pm2:stop": "pm2 stop yishan-official",
  "pm2:restart": "pm2 restart yishan-official",
  "pm2:logs": "pm2 logs yishan-official",
  ```

---

### 3. 文档文件更新（3个主要文档）

#### ✅ `DEPLOYMENT_GUIDE.md`
- **PM2进程名更新**: 所有 `pm2 ... yishan` 命令统一为 `yishan-official`
- **新增内容**: 
  - 添加"自动文档清理机制"章节（第379-423行）
  - 说明 `.gitattributes` + `deploy-clean.sh` 的工作原理
  - 列出保留和删除的文件类型
- **修改位置**:
  - 第63行: 部署流程图
  - 第258行: 首次部署成功标志
  - 第326行: PM2列表示例
  - 第332行: 查看运行日志
  - 第367-390行: 日常更新流程
  - 第403-411行: PM2命令速查表
  - 第417-428行: 日志查看技巧
  - 第432-433行: 日志文件路径
  - 第616行: 端口占用问题解决
  - 第691行: ecosystem.config.js示例
  - 第711行: 获取帮助
  - 第733行: 手动回滚

#### ✅ `QUICK_START.md`
- **PM2进程名更新**: 所有 PM2 命令统一
- **修改位置**:
  - 第97行: 手动回滚命令
  - 第108-109行: PM2管理命令
  - 第136行: 故障排查表
  - 第173行: 紧急联系

#### ✅ `DEPLOYMENT_SUMMARY.md`
- **PM2进程名更新**: 所有 PM2 命令统一
- **修改位置**:
  - 第113-117行: PM2管理命令
  - 第148行: 故障排查快速索引
  - 第215行: 部署流程图
  - 第235行: 部署检查清单
  - 第251行: 获取帮助

#### ✅ `env.example`
- **验证**: 域名和邮箱配置已正确（无需修改）
  - `NEXT_PUBLIC_SITE_URL=https://www.geokeji.com` ✅
  - `CONTACT_EMAIL=contact@geokeji.com` ✅

#### ✅ `README.md`
- **验证**: 无需修改（项目目录名 `yishan-official-site` 是正确的）

---

## 📋 验证清单

### ✅ 所有检查项均已通过

- [x] 所有脚本中的 `APP_NAME` 统一为 `yishan-official`
- [x] 所有文档中的域名为 `www.geokeji.com`
- [x] 所有文档中的邮箱为 `contact@geokeji.com`
- [x] `deploy.sh` 包含 `deploy-clean.sh` 调用（第22行）
- [x] 文档中说明了 `.gitattributes` 清理机制（DEPLOYMENT_GUIDE.md 第395-423行）
- [x] `package.json` 的 PM2 命令使用正确的进程名
- [x] `ecosystem.config.js` 的进程名为 `yishan-official`
- [x] 所有 PM2 相关命令文档已更新
- [x] 日志文件路径已更新为 `yishan-official-out.log` 和 `yishan-official-error.log`

---

## 🔍 文档清理机制说明

### 工作原理

本项目使用 **`.gitattributes` + `deploy-clean.sh`** 实现生产环境文档自动清理：

1. **标记阶段** (`.gitattributes`):
   ```
   AI开发指南.md export-ignore
   配置指南.md export-ignore
   README.md export-ignore
   DEPLOYMENT.md export-ignore
   .cursorrules export-ignore
   环境变量模板.env export-ignore
   ```

2. **清理阶段** (`scripts/deploy-clean.sh`):
   - 读取 `.gitattributes` 文件
   - 找出所有标记为 `export-ignore` 的文件
   - 在服务器上自动删除这些文件
   - 统计并显示删除文件数量

3. **调用时机**:
   - ✅ `deploy.sh` 第3步（拉取代码后，构建前）
   - ✅ `deploy-update.sh` 第3步（拉取代码后，构建前）
   - ✅ 首次部署脚本不调用（因为首次部署后才有完整文件）

### 保留vs删除

**保留的文件**:
- ✅ 博客文章 (`content/blog/*.md`)
- ✅ 环境变量 (`.env.local`)
- ✅ 所有业务代码
- ✅ 配置文件 (`package.json`, `next.config.ts` 等)
- ✅ 部署脚本 (`scripts/*.sh`)

**删除的文件**:
- ❌ 开发文档 (`AI开发指南.md`, `配置指南.md` 等)
- ❌ 开发配置 (`.cursorrules`, `环境变量模板.env` 等)
- ❌ 临时文件 (`commit-message.txt`)
- ❌ 安装脚本 (`install-node.bat`, `install-node.ps1`)

---

## 📊 脚本对比

### deploy.sh - 增强前vs增强后

| 功能 | 原版本 | 增强版 |
|------|--------|--------|
| 基础流程 | ✅ 5步 | ✅ 5步（保留）|
| 文档清理 | ✅ 调用 deploy-clean.sh | ✅ 保留 |
| 颜色输出 | ❌ 纯文本 | ✅ 彩色高亮 |
| 版本检测 | ❌ 无 | ✅ 无更新跳过 |
| 依赖智能检测 | ❌ 总是执行 npm install | ✅ package.json变化才执行 |
| 构建失败回滚 | ❌ 无 | ✅ 自动回滚 |
| PM2进程检测 | ❌ 无 | ✅ 未找到提示首次部署 |
| 部署结果统计 | ❌ 简单 | ✅ 详细（版本号、文件数等）|
| 日志输出 | ✅ 20行 | ✅ 10行（更简洁）|
| 错误提示 | ❌ 简单 | ✅ 详细（附解决方案）|

---

## 🎯 使用指南

### 首次部署

```bash
cd /www/server/geokeji
bash scripts/setup-git-deploy.sh
```

### 日常更新（两种方式任选其一）

**方式1: 使用增强版 deploy.sh（推荐）**
```bash
cd /www/server/geokeji
bash scripts/deploy.sh
```

**方式2: 使用 deploy-update.sh**
```bash
cd /www/server/geokeji
bash scripts/deploy-update.sh
```

**区别**:
- `deploy.sh`: 更简洁，适合快速更新
- `deploy-update.sh`: 功能更强大，输出更详细

### 紧急回滚

```bash
cd /www/server/geokeji
bash scripts/rollback.sh
```

---

## 🔧 常用命令

### PM2 管理

```bash
pm2 list                         # 查看所有服务
pm2 logs yishan-official         # 查看实时日志
pm2 restart yishan-official      # 重启服务
pm2 stop yishan-official         # 停止服务
pm2 monit                        # 实时监控
pm2 save                         # 保存进程列表
```

### 快捷命令（package.json）

```bash
npm run pm2:restart   # 重启服务
npm run pm2:logs      # 查看日志
npm run pm2:stop      # 停止服务
npm run pm2:status    # 查看状态

npm run deploy:setup     # 首次部署
npm run deploy:update    # 日常更新
npm run deploy:rollback  # 紧急回滚
```

---

## 📝 后续维护

### 添加需要清理的文件

编辑 `.gitattributes`，添加：
```
新文件.md export-ignore
```

### 修改PM2配置

编辑 `ecosystem.config.js`，然后：
```bash
pm2 delete yishan-official
pm2 start ecosystem.config.js
pm2 save
```

### 更新部署脚本

修改后无需特殊操作，下次部署时会自动使用新版本。

---

## ⚠️ 注意事项

1. **Windows 环境中文 Commit**:
   - ❌ 禁止直接使用 `git commit -m "中文"`
   - ✅ 必须使用 txt 文件方式（见 .cursorrules）

2. **PM2进程名**:
   - ✅ 统一使用 `yishan-official`
   - ❌ 不要使用 `yishan`（已弃用）

3. **文档清理**:
   - ✅ 服务器上自动删除开发文档
   - ✅ 本地保留所有文档
   - ✅ 博客文章（content/blog/*.md）永不删除

4. **环境变量**:
   - ✅ 域名: `https://www.geokeji.com`
   - ✅ 邮箱: `contact@geokeji.com`
   - ✅ 部署前确保 `.env.local` 已配置

---

## 📚 相关文档

- **[DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)** - 完整部署教程（Git SSH、首次部署、日常更新、问题排查）
- **[QUICK_START.md](./QUICK_START.md)** - 一页纸快速开始指南
- **[DEPLOYMENT_SUMMARY.md](./DEPLOYMENT_SUMMARY.md)** - 部署总结与快速索引
- **[scripts/README.md](./scripts/README.md)** - 部署脚本使用说明
- **[AI开发指南.md](./AI开发指南.md)** - 项目架构和开发约定（Cursor AI规范）

---

## ✅ 整合完成

**所有脚本已整合完毕，配置已统一，文档已更新，可以正常使用！**

**最后更新**: 2025-10-15  
**版本**: v1.0

