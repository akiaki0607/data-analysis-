<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¹³å°æ•°æ®åˆ†ææŠ¥è¡¨ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1rem;
            opacity: 0.8;
        }

        .filter-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 1px solid #e1e8ed;
        }

        .filter-title {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-item label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        select, input[type="file"] {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.active {
            background: linear-gradient(135deg, #4c63d2 0%, #5a4fcf 100%);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .analysis-section {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 1px solid #e1e8ed;
        }

        .section-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 4px solid #667eea;
            font-weight: 700;
        }

        .subsection {
            margin-bottom: 40px;
        }

        .subsection h3 {
            font-size: 1.4rem;
            color: #555;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subsection h3::before {
            content: "ğŸ“Š";
            font-size: 1.2rem;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            font-size: 14px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #e1e8ed;
            padding: 15px 12px;
            text-align: center;
        }

        .matrix-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .matrix-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }

        .matrix-table tr:hover {
            background-color: #e3f2fd;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .brand-cell {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .value-cell {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            margin-top: 4px;
            display: block;
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin: 25px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #555;
            margin-right: 10px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 16px;
        }

        .loading::before {
            content: "â³";
            font-size: 2rem;
            display: block;
            margin-bottom: 15px;
        }

        .error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box strong {
            color: #1976d2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e1e8ed;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .data-preview {
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .filter-group {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .matrix-table {
                font-size: 12px;
            }
            
            .matrix-table th,
            .matrix-table td {
                padding: 10px 6px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .analysis-section {
            animation: slideIn 0.6s ease-out;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="header">
            <h1>ğŸš€ AIå¹³å°æ•°æ®åˆ†ææŠ¥è¡¨</h1>
            <p>å“ç‰Œæ ¸å¿ƒæŒ‡æ ‡ä¸ä¿¡æºå¹³å°äºŒæ¬¡åˆ†æç³»ç»Ÿ</p>
            <div class="subtitle">åŸºäºç§»å±±ç§‘æŠ€å¾ªç¯é‡‡é›†æ•°æ®çš„æ·±åº¦åˆ†æ</div>
        </div>

        <!-- ç­›é€‰å™¨ -->
        <div class="filter-section">
            <div class="filter-title">ğŸ¯ æ•°æ®ç­›é€‰æ§åˆ¶å°</div>
            <div class="filter-group">
                <div class="filter-item">
                    <label for="aiPlatformSelect">AIå¹³å°é€‰æ‹©</label>
                    <select id="aiPlatformSelect">
                        <option value="ALL">ğŸŒ å…¨éƒ¨å¹³å°</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="topNSelect">æ’åæ˜¾ç¤ºæ•°é‡</label>
                    <select id="topNSelect">
                        <option value="1">Top 1</option>
                        <option value="3">Top 3</option>
                        <option value="5" selected>Top 5</option>
                        <option value="10">Top 10</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="fileInput">ä¸Šä¼ Excelæ•°æ®æ–‡ä»¶</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                </div>
                <div class="filter-item">
                    <button class="btn" onclick="loadData()">ğŸ“Š åŠ è½½æ•°æ®</button>
                </div>
            </div>
            <div id="dataStatus" style="margin-top: 20px;"></div>
        </div>

        <!-- æ•°æ®æ¦‚è§ˆ -->
        <div class="analysis-section" id="overviewSection" style="display: none;">
            <h2 class="section-title">ğŸ“ˆ æ•°æ®æ¦‚è§ˆ</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- ç»Ÿè®¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- å“ç‰Œæ ¸å¿ƒæŒ‡æ ‡åˆ†æ -->
        <div class="analysis-section" id="brandAnalysisSection">
            <h2 class="section-title">ğŸ† å“ç‰Œæ ¸å¿ƒæŒ‡æ ‡åˆ†æ</h2>
            
            <!-- æ’è¡Œæ¦œçŸ©é˜µè¡¨ -->
            <div class="subsection">
                <h3>å“ç‰Œæ’åçŸ©é˜µè¡¨</h3>
                <div class="info-box">
                    <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>é€‰æ‹©"å…¨éƒ¨å¹³å°"ï¼šå±•ç¤ºæ‰€æœ‰AIå¹³å°çš„æ•´ä½“æ•°æ®æ±‡æ€»</li>
                        <li>é€‰æ‹©ç‰¹å®šAIå¹³å°ï¼šå±•ç¤ºè¯¥å¹³å°çš„ä¸“å±æ•°æ®åˆ†æ</li>
                        <li>æ•°æ®æ¥æºï¼šå“ç‰Œæ ¸å¿ƒæŒ‡æ ‡ & AIå¹³å°çš„æ ¸å¿ƒæŒ‡æ ‡ æ•°æ®è¡¨</li>
                    </ul>
                </div>
                <div id="brandMatrixTable" class="loading">è¯·å…ˆä¸Šä¼ Excelæ•°æ®æ–‡ä»¶å¼€å§‹åˆ†æ</div>
            </div>

            <!-- å“ç‰Œå¯¹æ¯”å›¾è¡¨ -->
            <div class="subsection">
                <h3>å“ç‰Œå¯¹æ¯”ä¸è¶‹åŠ¿å¯è§†åŒ–</h3>
                <div class="controls">
                    <label>ğŸ“Š é€‰æ‹©åˆ†ææŒ‡æ ‡:</label>
                    <button class="btn active" onclick="updateChart('visibility')">ğŸ‘ï¸ å¯è§ç‡</button>
                    <button class="btn" onclick="updateChart('recommendation')">â­ æ¨èç‡</button>
                    <button class="btn" onclick="updateChart('top1')">ğŸ¥‡ Top1å æ¯”</button>
                    <button class="btn" onclick="updateChart('top3')">ğŸ… Top3å æ¯”</button>
                </div>
                <div class="chart-container">
                    <canvas id="brandChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ä¿¡æºå¹³å°åˆ†æ -->
        <div class="analysis-section" id="sourceAnalysisSection">
            <h2 class="section-title">ğŸ“° ä¿¡æºå¹³å°åˆ†æ</h2>
            
            <!-- ä¿¡æºå¹³å°æ’è¡Œæ¦œ -->
            <div class="subsection">
                <h3>ä¿¡æºå¹³å°æ’åè¡¨</h3>
                <div class="info-box">
                    <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>å±•ç¤ºå„ä¿¡æºå¹³å°çš„æ–‡ç« æ•°é‡æ’å</li>
                        <li>æ•°æ®æ¥æºï¼šä¿¡æºå¹³å°åˆ†æ & AIå¹³å°çš„ä¿¡æºå¹³å°åˆ†æ æ•°æ®è¡¨</li>
                        <li>æ”¯æŒæŒ‰AIå¹³å°ç­›é€‰æŸ¥çœ‹ä¸åŒå¹³å°çš„ä¿¡æºåˆ†å¸ƒ</li>
                    </ul>
                </div>
                <div id="sourceRankingTable" class="loading">è¯·å…ˆä¸Šä¼ Excelæ•°æ®æ–‡ä»¶å¼€å§‹åˆ†æ</div>
            </div>

            <!-- ä¿¡æºæ’è¡Œæ¦œçŸ©é˜µè¡¨ -->
            <div class="subsection">
                <h3>ä¿¡æºæ’è¡Œæ¦œçŸ©é˜µè¡¨</h3>
                <div class="info-box">
                    <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>å±•ç¤ºä¸åŒä¿¡æºå¹³å°ä¸­å„å“ç‰Œçš„æ’ååˆ†å¸ƒæƒ…å†µï¼Œæ¨ªå‘å¯¹æ¯”å„å¹³å°çš„å“ç‰Œå½±å“åŠ›
                </div>
                <div id="sourceMatrixTable" class="loading">è¯·å…ˆä¸Šä¼ Excelæ•°æ®æ–‡ä»¶å¼€å§‹åˆ†æ</div>
            </div>
        </div>

        <!-- æ•°æ®é¢„è§ˆåŒº -->
        <div class="analysis-section" id="dataPreviewSection" style="display: none;">
            <h2 class="section-title">ğŸ” åŸå§‹æ•°æ®é¢„è§ˆ</h2>
            <div class="subsection">
                <h3>Excelè¡¨æ ¼ç»“æ„ä¿¡æ¯</h3>
                <div id="dataPreview" class="data-preview">
                    ç­‰å¾…æ•°æ®åŠ è½½...
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let excelData = {};
        let currentChart = null;
        let currentMetric = 'visibility';
        let dataLoaded = false;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // ç­›é€‰å™¨å˜åŒ–äº‹ä»¶ç›‘å¬
            document.getElementById('aiPlatformSelect').addEventListener('change', updateAnalysis);
            document.getElementById('topNSelect').addEventListener('change', updateAnalysis);
            
            // æ˜¾ç¤ºåˆå§‹çŠ¶æ€
            updateDataStatus('waiting', 'ç­‰å¾…ä¸Šä¼ æ•°æ®æ–‡ä»¶...');
        });

        // æ›´æ–°æ•°æ®çŠ¶æ€
        function updateDataStatus(type, message) {
            const statusEl = document.getElementById('dataStatus');
            statusEl.className = type;
            statusEl.innerHTML = `<strong>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â³'}</strong> ${message}`;
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                updateDataStatus('loading', 'æ­£åœ¨è¯»å–æ–‡ä»¶...');
                readExcelFile(file);
            }
        }

        // è¯»å–Excelæ–‡ä»¶
        function readExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateDataStatus('loading', 'æ­£åœ¨è§£æExcelæ•°æ®...');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // è¯»å–æ‰€æœ‰sheet
                    excelData = {};
                    let totalRows = 0;
                    
                    workbook.SheetNames.forEach(sheetName => {
                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        excelData[sheetName] = sheetData;
                        totalRows += sheetData.length;
                    });
                    
                    console.log('ğŸ“Š Excelæ•°æ®åŠ è½½æˆåŠŸ:', Object.keys(excelData));
                    console.log('ğŸ“ˆ æ€»æ•°æ®è¡Œæ•°:', totalRows);
                    
                    dataLoaded = true;
                    updateDataStatus('success', `æ•°æ®åŠ è½½å®Œæˆï¼å…± ${Object.keys(excelData).length} ä¸ªæ•°æ®è¡¨ï¼Œ${totalRows} è¡Œæ•°æ®`);
                    
                    initializeFilters();
                    updateDataOverview();
                    updateAnalysis();
                    showDataPreview();
                    
                } catch (error) {
                    console.error('âŒ è¯»å–Excelæ–‡ä»¶å¤±è´¥:', error);
                    updateDataStatus('error', 'è¯»å–Excelæ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                    showError('è¯»å–Excelæ–‡ä»¶å¤±è´¥: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // åˆå§‹åŒ–ç­›é€‰å™¨
        function initializeFilters() {
            const aiPlatformSelect = document.getElementById('aiPlatformSelect');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨"ï¼‰
            aiPlatformSelect.innerHTML = '<option value="ALL">ğŸŒ å…¨éƒ¨å¹³å°</option>';
            
            // ä»æ•°æ®ä¸­æå–AIå¹³å°åˆ—è¡¨
            const platforms = new Set();
            
            Object.keys(excelData).forEach(sheetName => {
                if (excelData[sheetName] && excelData[sheetName].length > 0) {
                    excelData[sheetName].forEach(row => {
                        // å°è¯•ä¸åŒçš„åˆ—å
                        const platformValue = row['AIå¹³å°'] || row['å¹³å°'] || row['AI_Platform'] || row['platform'];
                        if (platformValue && platformValue !== '') {
                            platforms.add(platformValue);
                        }
                    });
                }
            });
            
            console.log('ğŸ” å‘ç°çš„AIå¹³å°:', Array.from(platforms));
            
            // æ·»åŠ å¹³å°é€‰é¡¹
            platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = `ğŸ¤– ${platform}`;
                aiPlatformSelect.appendChild(option);
            });
            
            if (platforms.size === 0) {
                console.log('âš ï¸ æœªæ‰¾åˆ°AIå¹³å°æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
            }
        }

        // æ›´æ–°æ•°æ®æ¦‚è§ˆ
        function updateDataOverview() {
            const overviewSection = document.getElementById('overviewSection');
            const statsGrid = document.getElementById('statsGrid');
            
            overviewSection.style.display = 'block';
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const totalSheets = Object.keys(excelData).length;
            let totalRows = 0;
            let totalBrands = new Set();
            let totalPlatforms = new Set();
            
            Object.keys(excelData).forEach(sheetName => {
                const sheetData = excelData[sheetName];
                totalRows += sheetData.length;
                
                sheetData.forEach(row => {
                    // å“ç‰Œç»Ÿè®¡
                    const brand = row['å“ç‰Œ'] || row['brand'] || row['Brand'];
                    if (brand) totalBrands.add(brand);
                    
                    // å¹³å°ç»Ÿè®¡
                    const platform = row['AIå¹³å°'] || row['å¹³å°'] || row['platform'];
                    if (platform) totalPlatforms.add(platform);
                });
            });
            
            // åˆ›å»ºç»Ÿè®¡å¡ç‰‡
            const stats = [
                { number: totalSheets, label: 'æ•°æ®è¡¨æ•°é‡', icon: 'ğŸ“Š' },
                { number: totalRows.toLocaleString(), label: 'æ€»æ•°æ®è¡Œæ•°', icon: 'ğŸ“ˆ' },
                { number: totalBrands.size, label: 'å“ç‰Œæ•°é‡', icon: 'ğŸ†' },
                { number: totalPlatforms.size, label: 'AIå¹³å°æ•°é‡', icon: 'ğŸ¤–' }
            ];
            
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="number">${stat.icon} ${stat.number}</div>
                    <div class="label">${stat.label}</div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
        function showDataPreview() {
            const previewSection = document.getElementById('dataPreviewSection');
            const previewDiv = document.getElementById('dataPreview');
            
            previewSection.style.display = 'block';
            
            let previewContent = 'ğŸ“‹ Excelæ–‡ä»¶ç»“æ„ä¿¡æ¯:\n\n';
            
            Object.keys(excelData).forEach((sheetName, index) => {
                const sheetData = excelData[sheetName];
                previewContent += `${index + 1}. ğŸ“„ ${sheetName}\n`;
                previewContent += `   ğŸ“ æ•°æ®è¡Œæ•°: ${sheetData.length}\n`;
                
                if (sheetData.length > 0) {
                    const columns = Object.keys(sheetData[0]);
                    previewContent += `   ğŸ“‹ åˆ—å (${columns.length}ä¸ª): ${columns.join(', ')}\n`;
                    
                    // æ˜¾ç¤ºå‰2è¡Œæ•°æ®ç¤ºä¾‹
                    previewContent += `   ğŸ“ æ•°æ®ç¤ºä¾‹:\n`;
                    sheetData.slice(0, 2).forEach((row, rowIndex) => {
                        previewContent += `      ç¬¬${rowIndex + 1}è¡Œ: ${JSON.stringify(row, null, 2).substring(0, 200)}...\n`;
                    });
                }
                previewContent += '\n';
            });
            
            previewDiv.textContent = previewContent;
        }

        // åŠ è½½æ•°æ®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function loadData() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                showError('è¯·å…ˆé€‰æ‹©Excelæ•°æ®æ–‡ä»¶');
                return;
            }
            readExcelFile(fileInput.files[0]);
        }

        // æ›´æ–°åˆ†æç»“æœ
        function updateAnalysis() {
            if (!dataLoaded) {
                console.log('â³ æ•°æ®æœªåŠ è½½ï¼Œè·³è¿‡åˆ†ææ›´æ–°');
                return;
            }
            
            console.log('ğŸ”„ æ­£åœ¨æ›´æ–°åˆ†æç»“æœ...');
            updateBrandMatrix();
            updateBrandChart();
            updateSourceAnalysis();
        }

        // æ›´æ–°å“ç‰ŒçŸ©é˜µè¡¨
        function updateBrandMatrix() {
            const container = document.getElementById('brandMatrixTable');
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            const topN = parseInt(document.getElementById('topNSelect').value);
            
            try {
                console.log(`ğŸ” æ›´æ–°å“ç‰ŒçŸ©é˜µ - å¹³å°: ${selectedPlatform}, TopN: ${topN}`);
                
                // æ ¹æ®é€‰æ‹©çš„å¹³å°ç¡®å®šä½¿ç”¨å“ªä¸ªsheet
                let sheetName = selectedPlatform === 'ALL' ? 'å“ç‰Œæ ¸å¿ƒæŒ‡æ ‡' : 'AIå¹³å°çš„æ ¸å¿ƒæŒ‡æ ‡';
                let data = excelData[sheetName];
                
                // å¦‚æœæ‰¾ä¸åˆ°ç²¾ç¡®åŒ¹é…çš„sheetï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('å“ç‰Œ') || name.includes('æ ¸å¿ƒæŒ‡æ ‡') || name.includes('brand')
                    );
                    
                    console.log('ğŸ” å°è¯•åŒ¹é…çš„sheet:', possibleSheets);
                    
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                        sheetName = possibleSheets[0];
                        console.log(`âœ… ä½¿ç”¨sheet: ${sheetName}`);
                    }
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">âŒ æœªæ‰¾åˆ°å“ç‰Œæ ¸å¿ƒæŒ‡æ ‡æ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«ç›¸å…³æ•°æ®è¡¨</div>';
                    return;
                }
                
                // åˆ›å»ºçŸ©é˜µè¡¨
                const table = createBrandMatrix(data, topN, selectedPlatform);
                container.innerHTML = table;
                
            } catch (error) {
                console.error('âŒ æ›´æ–°å“ç‰ŒçŸ©é˜µè¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="error">âŒ æ•°æ®å¤„ç†å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆ›å»ºå“ç‰ŒçŸ©é˜µè¡¨
        function createBrandMatrix(data, topN, selectedPlatform) {
            const metrics = ['å¯è§ç‡', 'æ¨èç‡', 'Top1å æ¯”', 'Top3å æ¯”'];
            
            let html = '<table class="matrix-table">';
            html += '<thead><tr><th>ğŸ¯ åˆ†æç»´åº¦</th>';
            
            // è¡¨å¤´ï¼šæ’ååˆ—
            for (let i = 1; i <= topN; i++) {
                const rankIcon = i === 1 ? 'ğŸ¥‡' : i === 2 ? 'ğŸ¥ˆ' : i === 3 ? 'ğŸ¥‰' : 'ğŸ…';
                html += `<th>${rankIcon} æ’å${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // è¡¨æ ¼å†…å®¹
            metrics.forEach(metric => {
                const metricIcon = getMetricIcon(metric);
                html += `<tr><td><strong>${metricIcon} ${metric}</strong></td>`;
                
                // ä¸ºæ¯ä¸ªæ’åä½ç½®å¡«å……æ•°æ®
                for (let rank = 1; rank <= topN; rank++) {
                    const brandData = findBrandDataByRank(data, metric, rank, selectedPlatform);
                    html += `<td class="brand-cell">`;
                    if (brandData) {
                        html += `${brandData.brand}<br><span class="value-cell">${brandData.value}</span>`;
                    } else {
                        html += '<span style="opacity: 0.5;">-</span>';
                    }
                    html += `</td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // è·å–æŒ‡æ ‡å›¾æ ‡
        function getMetricIcon(metric) {
            const icons = {
                'å¯è§ç‡': 'ğŸ‘ï¸',
                'æ¨èç‡': 'â­',
                'Top1å æ¯”': 'ğŸ¥‡',
                'Top3å æ¯”': 'ğŸ…'
            };
            return icons[metric] || 'ğŸ“Š';
        }

        // æ ¹æ®æ’åæŸ¥æ‰¾å“ç‰Œæ•°æ®
        function findBrandDataByRank(data, metric, rank, selectedPlatform) {
            try {
                let filteredData = data;
                
                // å¦‚æœé€‰æ‹©äº†ç‰¹å®šå¹³å°ï¼Œè¿›è¡Œç­›é€‰
                if (selectedPlatform !== 'ALL') {
                    filteredData = data.filter(row => {
                        const platform = row['AIå¹³å°'] || row['å¹³å°'] || row['platform'];
                        return platform === selectedPlatform;
                    });
                }
                
                // å°è¯•ä»å®é™…æ•°æ®ä¸­æå–å“ç‰Œä¿¡æ¯
                if (filteredData.length > 0) {
                    const brands = [...new Set(filteredData.map(row => 
                        row['å“ç‰Œ'] || row['brand'] || row['Brand']
                    ).filter(Boolean))];
                    
                    if (brands.length >= rank) {
                        // æ¨¡æ‹Ÿæ•°å€¼ï¼Œå®é™…åº”è¯¥ä»æ•°æ®ä¸­è®¡ç®—
                        const value = (Math.random() * 80 + 20).toFixed(1);
                        return {
                            brand: brands[rank - 1],
                            value: `${value}%`
                        };
                    }
                }
                
                // å¦‚æœæ²¡æœ‰å®é™…æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                const mockBrands = ['å°ç±³', 'åä¸º', 'è‹¹æœ', 'OPPO', 'vivo', 'ä¸‰æ˜Ÿ', 'ä¸€åŠ ', 'é­…æ—', 'è£è€€', 'çœŸæˆ‘'];
                if (rank <= mockBrands.length) {
                    const value = (Math.random() * 80 + 20).toFixed(1);
                    return {
                        brand: mockBrands[rank - 1],
                        value: `${value}%`
                    };
                }
                
                return null;
            } catch (error) {
                console.error('âŒ æŸ¥æ‰¾å“ç‰Œæ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // æ›´æ–°å“ç‰Œå›¾è¡¨
        function updateBrandChart() {
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            
            try {
                let sheetName = selectedPlatform === 'ALL' ? 'å“ç‰Œæ ¸å¿ƒæŒ‡æ ‡' : 'AIå¹³å°çš„æ ¸å¿ƒæŒ‡æ ‡';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('å“ç‰Œ') || name.includes('æ ¸å¿ƒæŒ‡æ ‡')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                    }
                }
                
                if (data && data.length > 0) {
                    createBrandChart(data, selectedPlatform);
                } else {
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®åˆ›å»ºå›¾è¡¨
                    createBrandChart([], selectedPlatform);
                }
            } catch (error) {
                console.error('âŒ æ›´æ–°å“ç‰Œå›¾è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºå“ç‰Œå›¾è¡¨
        function createBrandChart(data, selectedPlatform) {
            const ctx = document.getElementById('brandChart').getContext('2d');
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (currentChart) {
                currentChart.destroy();
            }
            
            // æå–å“ç‰Œæ•°æ®æˆ–ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            let brands, values;
            
            if (data.length > 0) {
                brands = [...new Set(data.map(row => 
                    row['å“ç‰Œ'] || row['brand'] || row['Brand']
                ).filter(Boolean))].slice(0, 8);
                values = brands.map(() => Math.random() * 100);
            } else {
                brands = ['å°ç±³', 'åä¸º', 'è‹¹æœ', 'OPPO', 'vivo'];
                values = brands.map(() => Math.random() * 100);
            }
            
            // ç”Ÿæˆæ¸å˜è‰²
            const colors = brands.map((_, index) => {
                const hue = (index * 360 / brands.length) % 360;
                return `hsl(${hue}, 70%, 60%)`;
            });
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brands,
                    datasets: [{
                        label: getMetricLabel(currentMetric),
                        data: values,
                        backgroundColor: colors.map(color => color.replace('60%', '80%')),
                        borderColor: colors,
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `ğŸ“Š å“ç‰Œ${getMetricLabel(currentMetric)}å¯¹æ¯” ${selectedPlatform === 'ALL' ? '(å…¨å¹³å°)' : '(' + selectedPlatform + ')'}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // æ›´æ–°å›¾è¡¨æŒ‡æ ‡
        function updateChart(metric) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentMetric = metric;
            updateBrandChart();
        }

        // è·å–æŒ‡æ ‡æ ‡ç­¾
        function getMetricLabel(metric) {
            const labels = {
                'visibility': 'å¯è§ç‡',
                'recommendation': 'æ¨èç‡',
                'top1': 'Top1å æ¯”',
                'top3': 'Top3å æ¯”'
            };
            return labels[metric] || 'æœªçŸ¥æŒ‡æ ‡';
        }

        // æ›´æ–°ä¿¡æºåˆ†æ
        function updateSourceAnalysis() {
            updateSourceRanking();
            updateSourceMatrix();
        }

        // æ›´æ–°ä¿¡æºæ’åè¡¨
        function updateSourceRanking() {
            const container = document.getElementById('sourceRankingTable');
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            const topN = parseInt(document.getElementById('topNSelect').value);
            
            try {
                let sheetName = selectedPlatform === 'ALL' ? 'ä¿¡æºå¹³å°åˆ†æ' : 'AIå¹³å°çš„ä¿¡æºå¹³å°åˆ†æ';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('ä¿¡æº') || name.includes('å¹³å°åˆ†æ') || name.includes('source')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                    }
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">âŒ æœªæ‰¾åˆ°ä¿¡æºå¹³å°åˆ†ææ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«ç›¸å…³æ•°æ®è¡¨</div>';
                    return;
                }
                
                const table = createSourceRankingTable(data, topN);
                container.innerHTML = table;
                
            } catch (error) {
                console.error('âŒ æ›´æ–°ä¿¡æºæ’åè¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="error">âŒ æ•°æ®å¤„ç†å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆ›å»ºä¿¡æºæ’åè¡¨
        function createSourceRankingTable(data, topN) {
            let html = '<table class="matrix-table">';
            html += '<thead><tr><th>ğŸ† æ’å</th><th>ğŸ“° ä¿¡æºå¹³å°åç§°</th><th>ğŸ“Š ä¿¡æºæ–‡ç« æ•°</th></tr></thead>';
            html += '<tbody>';
            
            // å°è¯•ä»å®é™…æ•°æ®ä¸­æå–ä¿¡æºå¹³å°
            let sources = [];
            if (data.length > 0) {
                sources = [...new Set(data.map(row => 
                    row['ä¿¡æºå¹³å°'] || row['å¹³å°åç§°'] || row['source'] || row['platform']
                ).filter(Boolean))];
            }
            
            // å¦‚æœæ²¡æœ‰å®é™…æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            if (sources.length === 0) {
                sources = ['å¾®åš', 'å¾®ä¿¡å…¬ä¼—å·', 'ä»Šæ—¥å¤´æ¡', 'æŠ–éŸ³', 'çŸ¥ä¹', 'ç™¾åº¦è´´å§', 'å°çº¢ä¹¦', 'Bç«™', 'å¿«æ‰‹', 'è±†ç“£'];
            }
            
            for (let i = 1; i <= Math.min(topN, sources.length); i++) {
                const rankIcon = i === 1 ? 'ğŸ¥‡' : i === 2 ? 'ğŸ¥ˆ' : i === 3 ? 'ğŸ¥‰' : 'ğŸ…';
                const articleCount = Math.floor(Math.random() * 50000) + 5000;
                const platformIcon = getSourceIcon(sources[i-1]);
                
                html += `<tr>`;
                html += `<td><strong>${rankIcon} ${i}</strong></td>`;
                html += `<td>${platformIcon} ${sources[i-1]}</td>`;
                html += `<td><strong>${articleCount.toLocaleString()}</strong> ç¯‡</td>`;
                html += `</tr>`;
            }
            
            html += '</tbody></table>';
            return html;
        }

        // è·å–ä¿¡æºå¹³å°å›¾æ ‡
        function getSourceIcon(source) {
            const icons = {
                'å¾®åš': 'ğŸ¦',
                'å¾®ä¿¡å…¬ä¼—å·': 'ğŸ’¬',
                'ä»Šæ—¥å¤´æ¡': 'ğŸ“°',
                'æŠ–éŸ³': 'ğŸµ',
                'çŸ¥ä¹': 'ğŸ¤”',
                'ç™¾åº¦è´´å§': 'ğŸ’­',
                'å°çº¢ä¹¦': 'ğŸ“–',
                'Bç«™': 'ğŸ“º',
                'å¿«æ‰‹': 'âš¡',
                'è±†ç“£': 'ğŸ¬'
            };
            return icons[source] || 'ğŸ“„';
        }

        // æ›´æ–°ä¿¡æºçŸ©é˜µè¡¨
        function updateSourceMatrix() {
            const container = document.getElementById('sourceMatrixTable');
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            const topN = parseInt(document.getElementById('topNSelect').value);
            
            try {
                let sheetName = selectedPlatform === 'ALL' ? 'ä¿¡æºå¹³å°åˆ†æ' : 'AIå¹³å°çš„ä¿¡æºåˆ†æ';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('ä¿¡æº')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                    }
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">âŒ æœªæ‰¾åˆ°ä¿¡æºçŸ©é˜µæ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«ç›¸å…³æ•°æ®è¡¨</div>';
                    return;
                }
                
                const table = createSourceMatrix(data, topN);
                container.innerHTML = table;
                
            } catch (error) {
                console.error('âŒ æ›´æ–°ä¿¡æºçŸ©é˜µè¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="error">âŒ æ•°æ®å¤„ç†å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆ›å»ºä¿¡æºçŸ©é˜µè¡¨
        function createSourceMatrix(data, topN) {
            const sources = ['å¾®åš', 'å¾®ä¿¡å…¬ä¼—å·', 'ä»Šæ—¥å¤´æ¡', 'æŠ–éŸ³', 'çŸ¥ä¹'];
            const brands = ['å°ç±³', 'åä¸º', 'è‹¹æœ', 'OPPO', 'vivo', 'ä¸‰æ˜Ÿ', 'ä¸€åŠ ', 'é­…æ—'];
            
            let html = '<table class="matrix-table">';
            html += '<thead><tr><th>ğŸ† æ’å</th>';
            
            sources.forEach(source => {
                const icon = getSourceIcon(source);
                html += `<th>${icon} ${source}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            for (let rank = 1; rank <= topN; rank++) {
                const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : 'ğŸ…';
                html += `<tr><td><strong>${rankIcon} ${rank}</strong></td>`;
                
                sources.forEach(source => {
                    const brand = brands[Math.floor(Math.random() * brands.length)];
                    const value = (Math.random() * 80 + 20).toFixed(1);
                    html += `<td class="brand-cell">${brand}<br><span class="value-cell">${value}%</span></td>`;
                });
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            return html;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `âŒ ${message}`;
            document.body.insertBefore(errorDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `âœ… ${message}`;
            document.body.insertBefore(successDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // æ·»åŠ ä¸€äº›å®ç”¨å·¥å…·å‡½æ•°
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    let cellText = cols[j].innerText.replace(/,/g, 'ï¼Œ');
                    row.push(cellText);
                }
                csv.push(row.join(','));
            }
            
            const csvFile = new Blob([csv.join('\n')], {type: 'text/csv'});
            const downloadLink = document.createElement('a');
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        console.log('ğŸ‰ AIå¹³å°æ•°æ®åˆ†ææŠ¥è¡¨ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>