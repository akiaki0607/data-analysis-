<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI平台数据分析报表</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-item label {
            font-weight: 600;
            color: #555;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .analysis-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .subsection {
            margin-bottom: 30px;
        }

        .subsection h3 {
            font-size: 1.3rem;
            color: #555;
            margin-bottom: 15px;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: center;
        }

        .matrix-table th {
            background-color: #667eea;
            color: white;
            font-weight: 600;
        }

        .matrix-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .matrix-table tr:hover {
            background-color: #e3f2fd;
        }

        .brand-cell {
            font-weight: 600;
            color: #333;
        }

        .value-cell {
            font-size: 12px;
            color: #666;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #5a6fd8;
        }

        .btn.active {
            background-color: #4c63d2;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .matrix-table {
                font-size: 12px;
            }
            
            .matrix-table th,
            .matrix-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面标题 -->
        <div class="header">
            <h1>AI平台数据分析报表</h1>
            <p>品牌核心指标与信源平台二次分析</p>
        </div>

        <!-- 筛选器 -->
        <div class="filter-section">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="aiPlatformSelect">AI平台:</label>
                    <select id="aiPlatformSelect">
                        <option value="ALL">全部</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="topNSelect">TopN显示:</label>
                    <select id="topNSelect">
                        <option value="3">Top 3</option>
                        <option value="5" selected>Top 5</option>
                        <option value="10">Top 10</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="fileInput">上传数据文件:</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                </div>
                <button class="btn" onclick="loadData()">加载数据</button>
            </div>
        </div>

        <!-- 品牌核心指标分析 -->
        <div class="analysis-section" id="brandAnalysisSection">
            <h2 class="section-title">品牌核心指标分析</h2>
            
            <!-- 排行榜矩阵表 -->
            <div class="subsection">
                <h3>A. 品牌排名矩阵表</h3>
                <div class="info-box">
                    <strong>说明：</strong>如果选择"全部"，展示整体数据；如果选择某AI平台，展示对应平台的数据
                </div>
                <div id="brandMatrixTable" class="loading">请先上传数据文件</div>
            </div>

            <!-- 品牌对比图表 -->
            <div class="subsection">
                <h3>B. 品牌对比与趋势</h3>
                <div class="controls">
                    <label>选择指标:</label>
                    <button class="btn active" onclick="updateChart('visibility')">可见率</button>
                    <button class="btn" onclick="updateChart('recommendation')">推荐率</button>
                    <button class="btn" onclick="updateChart('top1')">Top1占比</button>
                    <button class="btn" onclick="updateChart('top3')">Top3占比</button>
                </div>
                <div class="chart-container">
                    <canvas id="brandChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 信源平台分析 -->
        <div class="analysis-section" id="sourceAnalysisSection">
            <h2 class="section-title">信源平台分析</h2>
            
            <!-- 信源平台排行榜 -->
            <div class="subsection">
                <h3>A. 信源平台排名表</h3>
                <div class="info-box">
                    <strong>说明：</strong>如果选择"全部"，展示整体数据；如果选择某AI平台，展示对应平台的数据
                </div>
                <div id="sourceRankingTable" class="loading">请先上传数据文件</div>
            </div>

            <!-- 信源排行榜矩阵表 -->
            <div class="subsection">
                <h3>B. 信源排行榜矩阵表</h3>
                <div id="sourceMatrixTable" class="loading">请先上传数据文件</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let excelData = {};
        let currentChart = null;
        let currentMetric = 'visibility';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 文件上传事件监听
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // 筛选器变化事件监听
            document.getElementById('aiPlatformSelect').addEventListener('change', updateAnalysis);
            document.getElementById('topNSelect').addEventListener('change', updateAnalysis);
        });

        // 处理文件选择
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                readExcelFile(file);
            }
        }

        // 读取Excel文件
        function readExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 读取所有sheet
                    excelData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        excelData[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    });
                    
                    console.log('Excel数据加载成功:', Object.keys(excelData));
                    initializeFilters();
                    updateAnalysis();
                    
                } catch (error) {
                    console.error('读取Excel文件失败:', error);
                    showError('读取Excel文件失败，请检查文件格式');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 初始化筛选器
        function initializeFilters() {
            const aiPlatformSelect = document.getElementById('aiPlatformSelect');
            
            // 清空现有选项（保留"全部"）
            aiPlatformSelect.innerHTML = '<option value="ALL">全部</option>';
            
            // 从数据中提取AI平台列表
            const platforms = new Set();
            Object.keys(excelData).forEach(sheetName => {
                if (excelData[sheetName] && excelData[sheetName].length > 0) {
                    excelData[sheetName].forEach(row => {
                        if (row['AI平台'] || row['平台'] || row['AI_Platform']) {
                            platforms.add(row['AI平台'] || row['平台'] || row['AI_Platform']);
                        }
                    });
                }
            });
            
            // 添加平台选项
            platforms.forEach(platform => {
                if (platform && platform !== '') {
                    const option = document.createElement('option');
                    option.value = platform;
                    option.textContent = platform;
                    aiPlatformSelect.appendChild(option);
                }
            });
        }

        // 加载数据按钮点击事件
        function loadData() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) {
                alert('请先选择数据文件');
                return;
            }
            readExcelFile(fileInput.files[0]);
        }

        // 更新分析结果
        function updateAnalysis() {
            if (!excelData || Object.keys(excelData).length === 0) {
                return;
            }
            
            updateBrandMatrix();
            updateBrandChart();
            updateSourceAnalysis();
        }

        // 更新品牌矩阵表
        function updateBrandMatrix() {
            const container = document.getElementById('brandMatrixTable');
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            const topN = parseInt(document.getElementById('topNSelect').value);
            
            try {
                // 根据选择的平台确定使用哪个sheet
                let sheetName = selectedPlatform === 'ALL' ? '品牌核心指标' : 'AI平台的核心指标';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    // 尝试其他可能的sheet名称
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('品牌') || name.includes('核心指标')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                        sheetName = possibleSheets[0];
                    }
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">未找到品牌核心指标数据</div>';
                    return;
                }
                
                // 创建矩阵表
                const table = createBrandMatrix(data, topN, selectedPlatform);
                container.innerHTML = table;
                
            } catch (error) {
                console.error('更新品牌矩阵表失败:', error);
                container.innerHTML = '<div class="error">数据处理失败</div>';
            }
        }

        // 创建品牌矩阵表
        function createBrandMatrix(data, topN, selectedPlatform) {
            const metrics = ['可见率', '推荐率', 'Top1占比', 'Top3占比'];
            
            let html = '<table class="matrix-table">';
            html += '<thead><tr><th>分析维度</th>';
            
            // 表头：排名列
            for (let i = 1; i <= topN; i++) {
                html += `<th>排名${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // 表格内容
            metrics.forEach(metric => {
                html += `<tr><td><strong>${metric}</strong></td>`;
                
                // 为每个排名位置填充数据
                for (let rank = 1; rank <= topN; rank++) {
                    const brandData = findBrandDataByRank(data, metric, rank, selectedPlatform);
                    html += `<td class="brand-cell">`;
                    if (brandData) {
                        html += `${brandData.brand}<br><span class="value-cell">${brandData.value}</span>`;
                    } else {
                        html += '-';
                    }
                    html += `</td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // 根据排名查找品牌数据
        function findBrandDataByRank(data, metric, rank, selectedPlatform) {
            // 这里需要根据实际数据结构来实现
            // 示例实现，需要根据实际Excel结构调整
            try {
                let filteredData = data;
                if (selectedPlatform !== 'ALL') {
                    filteredData = data.filter(row => 
                        (row['AI平台'] || row['平台']) === selectedPlatform
                    );
                }
                
                // 模拟数据，实际需要根据Excel结构调整
                const brands = ['小米', '华为', '苹果', 'OPPO', 'vivo', '三星', '一加', '魅族'];
                if (rank <= brands.length) {
                    return {
                        brand: brands[rank - 1],
                        value: `${(Math.random() * 100).toFixed(1)}%`
                    };
                }
                return null;
            } catch (error) {
                console.error('查找品牌数据失败:', error);
                return null;
            }
        }

        // 更新品牌图表
        function updateBrandChart() {
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            
            try {
                let sheetName = selectedPlatform === 'ALL' ? '品牌核心指标' : 'AI平台的核心指标';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('品牌') || name.includes('核心指标')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                    }
                }
                
                if (data && data.length > 0) {
                    createBrandChart(data, selectedPlatform);
                }
            } catch (error) {
                console.error('更新品牌图表失败:', error);
            }
        }

        // 创建品牌图表
        function createBrandChart(data, selectedPlatform) {
            const ctx = document.getElementById('brandChart').getContext('2d');
            
            // 销毁现有图表
            if (currentChart) {
                currentChart.destroy();
            }
            
            // 模拟数据，实际需要从Excel中提取
            const brands = ['小米', '华为', '苹果', 'OPPO', 'vivo'];
            const values = brands.map(() => Math.random() * 100);
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: brands,
                    datasets: [{
                        label: getMetricLabel(currentMetric),
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `品牌${getMetricLabel(currentMetric)}对比 ${selectedPlatform === 'ALL' ? '(全平台)' : '(' + selectedPlatform + ')'}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新图表指标
        function updateChart(metric) {
            // 更新按钮状态
            document.querySelectorAll('.controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentMetric = metric;
            updateBrandChart();
        }

        // 获取指标标签
        function getMetricLabel(metric) {
            const labels = {
                'visibility': '可见率',
                'recommendation': '推荐率',
                'top1': 'Top1占比',
                'top3': 'Top3占比'
            };
            return labels[metric] || '未知指标';
        }

        // 更新信源分析
        function updateSourceAnalysis() {
            updateSourceRanking();
            updateSourceMatrix();
        }

        // 更新信源排名表
        function updateSourceRanking() {
            const container = document.getElementById('sourceRankingTable');
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            const topN = parseInt(document.getElementById('topNSelect').value);
            
            try {
                let sheetName = selectedPlatform === 'ALL' ? '信源平台分析' : 'AI平台的信源平台分析';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('信源') || name.includes('平台分析')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                    }
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">未找到信源平台分析数据</div>';
                    return;
                }
                
                const table = createSourceRankingTable(data, topN);
                container.innerHTML = table;
                
            } catch (error) {
                console.error('更新信源排名表失败:', error);
                container.innerHTML = '<div class="error">数据处理失败</div>';
            }
        }

        // 创建信源排名表
        function createSourceRankingTable(data, topN) {
            let html = '<table class="matrix-table">';
            html += '<thead><tr><th>排名</th><th>信源平台名称</th><th>信源文章数</th></tr></thead>';
            html += '<tbody>';
            
            // 模拟数据，实际需要从Excel中提取和排序
            const sources = ['微博', '微信公众号', '今日头条', '抖音', '知乎', '百度贴吧', '小红书', 'B站'];
            
            for (let i = 1; i <= Math.min(topN, sources.length); i++) {
                const articleCount = Math.floor(Math.random() * 10000) + 1000;
                html += `<tr>`;
                html += `<td><strong>${i}</strong></td>`;
                html += `<td>${sources[i-1]}</td>`;
                html += `<td>${articleCount.toLocaleString()}</td>`;
                html += `</tr>`;
            }
            
            html += '</tbody></table>';
            return html;
        }

        // 更新信源矩阵表
        function updateSourceMatrix() {
            const container = document.getElementById('sourceMatrixTable');
            const selectedPlatform = document.getElementById('aiPlatformSelect').value;
            const topN = parseInt(document.getElementById('topNSelect').value);
            
            try {
                let sheetName = selectedPlatform === 'ALL' ? '信源平台分析' : 'AI平台的信源分析';
                let data = excelData[sheetName];
                
                if (!data || data.length === 0) {
                    const possibleSheets = Object.keys(excelData).filter(name => 
                        name.includes('信源')
                    );
                    if (possibleSheets.length > 0) {
                        data = excelData[possibleSheets[0]];
                    }
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error">未找到信源矩阵数据</div>';
                    return;
                }
                
                const table = createSourceMatrix(data, topN);
                container.innerHTML = table;
                
            } catch (error) {
                console.error('更新信源矩阵表失败:', error);
                container.innerHTML = '<div class="error">数据处理失败</div>';
            }
        }

        // 创建信源矩阵表
        function createSourceMatrix(data, topN) {
            const sources = ['微博', '微信公众号', '今日头条', '抖音', '知乎'];
            const brands = ['小米', '华为', '苹果', 'OPPO', 'vivo'];
            
            let html = '<table class="matrix-table">';
            html += '<thead><tr><th>排名</th>';
            
            sources.forEach(source => {
                html += `<th>${source}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            for (let rank = 1; rank <= topN; rank++) {
                html += `<tr><td><strong>${rank}</strong></td>`;
                
                sources.forEach(source => {
                    const brand = brands[Math.floor(Math.random() * brands.length)];
                    const value = (Math.random() * 100).toFixed(1);
                    html += `<td class="brand-cell">${brand}<br><span class="value-cell">${value}%</span></td>`;
                });
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            return html;
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>