# 自动化测试用例说明文档

## 📝 文档概述

本文档详细说明基于 `需求描述_1015V3.1_技术方案.md` 创建的自动化测试用例。

## 🎯 测试目标

1. **确保功能完整性**：验证所有需求文档中定义的功能
2. **数据准确性**：验证数据计算和展示的正确性
3. **用户交互**：验证前端交互逻辑符合需求
4. **API稳定性**：验证后端API的可靠性和容错性
5. **独立筛选器**：重点验证两个模块的AI平台筛选器独立性（需求6.1.3）

## 📊 测试用例详细说明

### 1. API接口测试 (test_api.py)

#### 1.1 健康检查测试
**测试用例**: `TestAPIHealth::test_health_check`
**需求来源**: 技术方案 6.2 API设计
**测试目的**: 验证后端服务正常运行
**测试步骤**:
1. 发送GET请求到 `/api/health`
2. 验证响应状态码为200
3. 验证返回数据包含 `status: ok` 和 `timestamp`

**预期结果**: 服务健康检查通过

---

#### 1.2 演示数据结构测试
**测试用例**: `TestDemoData::test_demo_data_structure`
**需求来源**: 需求1.2数据封面、1.3两大模块
**测试目的**: 验证演示数据包含所有必需模块
**测试步骤**:
1. 请求 `/api/demo-data`
2. 验证返回数据包含：
   - `metadata` - 元数据
   - `brand_metrics` - 品牌核心指标
   - `platform_metrics` - AI平台指标
   - `keyword_analysis` - 关键词分析

**预期结果**: 所有必需的数据模块都存在

---

#### 1.3 元数据字段完整性测试
**测试用例**: `TestDemoData::test_metadata_fields`
**需求来源**: 需求1.2数据封面
**测试目的**: 验证元数据包含所有必需字段
**测试字段**:
- 客户名称
- 分析周期
- AI平台（列表格式）
- 采集关键词数
- 循环次数

**预期结果**: 所有必需字段都存在且格式正确

---

#### 1.4 品牌核心指标结构测试
**测试用例**: `TestDemoData::test_brand_metrics_structure`
**需求来源**: 需求1.3(1)品牌排名矩阵表
**测试目的**: 验证品牌指标数据结构
**测试指标**:
- 可见概率
- Top1占比
- Top3占比

**验证内容**:
- 每个指标是列表格式
- 每个数据项包含：品牌、排名、指标值

**预期结果**: 数据结构符合前端渲染需求

---

#### 1.5 AI平台指标结构测试
**测试用例**: `TestDemoData::test_platform_metrics_structure`
**需求来源**: 需求3.2.2 AI平台的核心指标Sheet
**测试目的**: 验证每个AI平台有独立的指标数据
**测试步骤**:
1. 获取演示数据
2. 验证 `platform_metrics` 不为空
3. 验证每个平台都有可见概率等指标

**预期结果**: 每个平台的数据结构完整

---

#### 1.6 文件上传测试
**测试用例**: `TestFileUpload::test_upload_without_file`
**需求来源**: 需求6.5.4异常处理
**测试目的**: 验证未上传文件时的错误处理
**预期结果**: 返回400错误，错误码为 `NO_FILE`

---

**测试用例**: `TestFileUpload::test_upload_invalid_format`
**需求来源**: 需求6.5.4异常处理
**测试目的**: 验证上传不支持格式时的错误处理
**预期结果**: 返回400错误，错误码为 `INVALID_FORMAT`

---

**测试用例**: `TestFileUpload::test_upload_valid_excel`
**需求来源**: 需求1.1数据上传、技术方案6.2完整处理流程
**测试目的**: 验证正常Excel文件的上传和分析
**测试文件**: `取3sheet2025105思迈特_测试少量样本.xlsx`
**测试步骤**:
1. 上传测试Excel文件
2. 等待分析完成
3. 验证返回状态为success
4. 验证返回数据包含元数据和品牌指标
5. 验证处理时间被记录

**预期结果**: 
- 文件上传成功
- 分析完成并返回结构化数据
- 元数据正确提取（客户名称：思迈特）

---

#### 1.7 数据验证测试
**测试用例**: `TestDataValidation::test_percentage_values`
**需求来源**: 需求3.5数据一致性与校验
**测试目的**: 验证所有百分比数据在0-100范围内
**测试指标**: 可见概率、推荐概率、Top1占比、Top3占比等
**预期结果**: 所有百分比值 ∈ [0, 100]

---

**测试用例**: `TestDataValidation::test_ranking_consistency`
**需求来源**: 需求3.5数据一致性与校验
**测试目的**: 验证排名数据的连续性
**验证规则**: 排名应从1开始，连续递增，无跳跃
**预期结果**: 排名序列 = [1, 2, 3, ..., N]

---

#### 1.8 AI平台筛选器独立性测试 ⭐重点
**测试用例**: `TestPlatformFilterIndependence::test_brand_metrics_platform_options`
**需求来源**: **需求6.1.3前端页面结构与交互逻辑**
**测试目的**: 验证品牌核心指标支持"所有AI平台"选项
**测试步骤**:
1. 获取演示数据
2. 检查元数据中的AI平台列表
3. 验证 `platform_metrics` 有每个平台的数据

**预期结果**: 
- 品牌核心指标可以展示"所有AI平台"的聚合数据
- 也可以切换到单个平台查看

---

**测试用例**: `TestPlatformFilterIndependence::test_keyword_analysis_platform_options`
**需求来源**: **需求6.1.3前端页面结构与交互逻辑**
**测试目的**: 验证关键词分析不包含"所有AI平台"选项
**关键需求**: 
> 关键词分析的AI平台筛选器：[豆包▾] [元宝] [DeepSeek]
> （注意：无"所有AI平台"选项）

**测试步骤**:
1. 获取关键词分析数据
2. 验证数据按平台分组
3. 确认每个平台有独立的关键词数据

**预期结果**: 
- 关键词分析数据按平台独立存储
- 前端只能选择单个平台，不支持"所有平台"聚合

---

### 2. 数据处理器测试 (test_data_processor.py)

#### 2.1 处理器初始化测试
**测试用例**: `TestDataProcessor::test_processor_initialization`
**测试目的**: 验证数据处理器正确初始化
**预期结果**: Schema和文件路径正确保存

---

#### 2.2 列字母转索引测试
**测试用例**: `TestDataProcessor::test_col_letter_to_index`
**需求来源**: 技术方案6.2.1 LLM职责
**测试目的**: 验证Excel列字母到索引的转换
**测试用例**:
- A → 0
- B → 1
- Z → 25
- AA → 26
- AB → 27

**预期结果**: 所有转换正确

---

#### 2.3 元数据提取测试
**测试用例**: `TestMetadataExtraction::test_extract_metadata_from_real_file`
**需求来源**: 需求3.2.1数据封面Sheet
**测试目的**: 验证从真实文件提取元数据
**验证内容**:
- Sheet不为空
- 至少有2列
- 包含"客户名称"字段

**预期结果**: 元数据正确提取

---

#### 2.4 百分比计算测试
**测试用例**: `TestDataCalculation::test_percentage_calculation`
**需求来源**: 技术方案6.3.1 Python计算引擎职责
**测试目的**: 验证百分比计算准确性
**测试数据**:
- 品牌A: 45/100 = 45%
- 品牌B: 35/100 = 35%
- 品牌C: 20/100 = 20%

**预期结果**: 计算结果精确到小数点后2位

---

#### 2.5 排名计算测试
**测试用例**: `TestDataCalculation::test_ranking_calculation`
**需求来源**: 需求1.3(1)品牌排名矩阵表
**测试目的**: 验证排名计算逻辑（分数高排名靠前）
**测试数据**:
- 品牌B: 92分 → 排名1
- 品牌A: 85分 → 排名2
- 品牌C: 78分 → 排名3

**预期结果**: 排名计算正确

---

#### 2.6 数据验证规则测试
**测试用例**: `TestDataValidation::test_percentage_range`
**需求来源**: 需求3.5数据一致性与校验
**测试目的**: 验证百分比范围检查逻辑
**有效值**: 0, 25.5, 50, 75.8, 100
**无效值**: -1, 100.1, 150

**预期结果**: 正确识别有效和无效值

---

**测试用例**: `TestDataValidation::test_ranking_continuity`
**需求来源**: 需求3.5数据一致性与校验
**测试目的**: 验证排名连续性检查
**有效排名**: [1, 2, 3, 4, 5]
**无效排名**: [1, 2, 4, 5] (缺3)

**预期结果**: 正确识别排名是否连续

---

### 3. 前端功能测试 (test_frontend.py)

#### 3.1 页面加载测试
**测试用例**: `TestFrontendBasic::test_page_load`
**需求来源**: 需求1.1顶部区域
**测试目的**: 验证页面能正常加载
**预期结果**: 页面标题包含"AI平台数据分析报告"

---

#### 3.2 上传按钮测试
**测试用例**: `TestFrontendBasic::test_upload_button_exists`
**需求来源**: 需求1.1数据上传
**测试目的**: 验证上传组件存在
**预期结果**: uploadArea和fileInput元素存在

---

#### 3.3 演示数据按钮测试
**测试用例**: `TestFrontendBasic::test_demo_button_exists`
**需求来源**: 需求1.1使用演示数据
**测试目的**: 验证演示数据按钮存在且可见
**预期结果**: demoBtn元素存在且显示

---

#### 3.4 演示数据加载测试
**测试用例**: `TestDemoDataDisplay::test_load_demo_data`
**需求来源**: 需求1.2数据封面
**测试目的**: 验证点击演示数据后数据正确加载
**测试步骤**:
1. 点击演示数据按钮
2. 等待数据封面显示
3. 验证数据封面可见

**预期结果**: 数据封面正确显示

---

#### 3.5 元数据显示测试
**测试用例**: `TestDemoDataDisplay::test_metadata_display`
**需求来源**: 需求1.2数据封面字段
**测试目的**: 验证元数据内容正确显示
**预期结果**: 数据封面包含客户名称等信息

---

#### 3.6 Tab切换测试
**测试用例**: `TestTabSwitching::test_tab_switching`
**需求来源**: 需求1.3两大模块Tab切换
**测试目的**: 验证Tab切换功能
**测试步骤**:
1. 默认在"品牌核心指标"Tab
2. 点击"关键词分析"Tab
3. 验证Tab状态改变

**预期结果**: Tab切换正常，active状态正确

---

#### 3.7 品牌核心指标平台筛选器测试 ⭐
**测试用例**: `TestPlatformFilters::test_brand_metrics_platform_filter`
**需求来源**: **需求6.1.3 图表对比**
**关键需求**:
> 品牌核心指标模块
> AI平台筛选器：[所有AI平台▾] [豆包] [元宝] [DeepSeek]

**测试步骤**:
1. 切换到品牌核心指标Tab
2. 找到平台筛选器元素
3. 获取所有选项
4. 验证包含"所有AI平台"

**预期结果**: 
- 筛选器存在
- 包含"所有AI平台"选项
- 包含具体平台选项（豆包、元宝、DeepSeek）

---

#### 3.8 关键词分析平台筛选器测试 ⭐
**测试用例**: `TestPlatformFilters::test_keyword_analysis_platform_filter`
**需求来源**: **需求6.1.3 图表对比**
**关键需求**:
> 关键词分析模块
> AI平台筛选器：[豆包▾] [元宝] [DeepSeek]
> （注意：无"所有AI平台"选项）

**测试步骤**:
1. 切换到关键词分析Tab
2. 找到平台筛选器元素
3. 获取所有选项
4. 验证不包含"所有AI平台"

**预期结果**: 
- 筛选器存在
- **不包含**"所有AI平台"选项
- 只有具体平台选项（豆包、元宝、DeepSeek）

---

#### 3.9 筛选器独立性测试 ⭐⭐重中之重
**测试用例**: `TestPlatformFilters::test_filters_independence`
**需求来源**: **需求6.1.3 前端状态管理示例**
**关键需求**:
> 前端需要维护两个独立的状态：
> - `brandMetrics.selectedPlatform` - 品牌核心指标的选择
> - `keywordAnalysis.selectedPlatform` - 关键词分析的选择

**测试目的**: 验证两个模块的筛选器完全独立，互不影响

**测试步骤**:
1. 在品牌核心指标选择一个平台
2. 记录选择结果
3. 切换到关键词分析Tab
4. 检查关键词分析的筛选器选择
5. 验证两个筛选器的选择是独立的

**预期结果**: 
- 两个筛选器各自维护自己的状态
- 切换Tab不会影响另一个筛选器的选择
- 每个模块的筛选器有自己的枚举值范围

---

#### 3.10 图表渲染测试
**测试用例**: `TestDataVisualization::test_chart_rendering`
**需求来源**: 需求1.3(2)品牌对比图
**测试目的**: 验证Chart.js图表正确渲染
**预期结果**: 找到brandChart canvas元素

---

## 🚀 运行测试

### 快速运行
```bash
# 运行所有测试（跳过前端）
python tests/run_all_tests.py --skip-frontend

# 只运行API测试
python tests/run_all_tests.py --type api

# 只运行数据处理器测试
python tests/run_all_tests.py --type processor

# 运行前端测试（需要Chrome）
python tests/run_all_tests.py --type frontend
```

### 详细模式
```bash
python tests/run_all_tests.py --verbose
```

### 生成HTML报告
```bash
python tests/run_all_tests.py --report
```

## 📈 测试覆盖率

当前测试覆盖：
- ✅ **12个** API接口测试
- ✅ **7个** 数据处理器测试
- ✅ **9个** 前端功能测试
- ✅ **总计28个**自动化测试用例

重点覆盖的需求：
- ✅ 需求1.1 - 1.3：前端交互和数据展示
- ✅ 需求3.2：四个Sheet的数据结构
- ✅ 需求3.5：数据验证规则
- ✅ **需求6.1.3**：AI平台筛选器独立性（重点）
- ✅ 需求6.2：API设计
- ✅ 需求6.3：数据处理流程
- ✅ 需求6.5.4：异常处理

## ✅ 测试结果

最新测试运行结果：
```
🔍 检查服务状态...
  ✅ 前端服务运行正常 (端口 3000)
  ✅ 后端服务运行正常 (端口 5001)

📝 运行测试文件: test_api.py
----------------------------------------------------------------------
✅ 健康检查测试通过
✅ 演示数据结构测试通过
✅ 元数据字段测试通过
✅ 品牌核心指标结构测试通过
✅ AI平台指标结构测试通过
✅ 无文件上传测试通过
✅ 无效文件格式测试通过
✅ Excel文件上传测试通过 (耗时: 12.82秒)
   元数据: 思迈特
✅ 百分比数据范围测试通过
✅ 排名一致性测试通过
✅ 品牌核心指标平台选项测试通过
✅ 关键词分析平台选项测试通过

============================= 12 passed in 12.90s ==============================

✅ 所有测试通过！
```

## 📚 参考文档

- 需求文档：`../需求_副本/需求描述_1015V3.1_技术方案.md`
- 测试说明：`tests/README.md`
- 项目主README：`../README.md`

